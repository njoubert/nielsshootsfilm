# Apache Configuration for Photography Portfolio Site
#
# This template adds SPA routing and cache control to your existing Apache configuration.
# Based on your working nielsshootsfilm.com.conf
#
# Installation:
# 1. Review the generated configuration
# 2. Copy/merge the additions into /etc/apache2/sites-available/nielsshootsfilm.com.conf
# 3. Enable required modules: sudo a2enmod rewrite headers expires deflate
# 4. Test config: sudo apache2ctl configtest
# 5. Reload Apache: sudo systemctl reload apache2

# HTTP to HTTPS redirect (you already have this configured)
<VirtualHost *:80>
    ServerName ${SITE_URL}
    ServerAlias *.${SITE_URL}
    <Location "/">
        Redirect permanent "https://%{HTTP_HOST}%{REQUEST_URI}"
    </Location>
</VirtualHost>

# HTTPS configuration
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName ${SITE_URL}
    ServerAlias *.${SITE_URL}

    # Set the main document root
    DocumentRoot /var/www/${SITE_URL}

    # Rewrite www to naked domain (you already have this)
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^www.${SITE_URL}$ [NC]
    RewriteRule ^(.*)$ https://${SITE_URL}$1 [R=301,L]

    # Main directory configuration - ADD SPA ROUTING HERE
    <Directory /var/www/${SITE_URL}/>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted

        # SPA routing - ADD THESE RULES
        RewriteEngine On

        # Prevent rewrite loop - if already rewritten, stop
        RewriteCond %{ENV:REDIRECT_STATUS} !^$
        RewriteRule ^ - [L]

        # Explicitly exclude static file directories from SPA fallback
        RewriteRule ^assets/ - [L]
        RewriteRule ^uploads/ - [L]
        RewriteRule ^data/ - [L]

        # Don't rewrite if the file or directory exists
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d

        # Serve index.html for all other routes (SPA fallback)
        RewriteRule ^ /index.html [L]
    </Directory>

    # Cache control for static assets - ADD THIS SECTION
    <Directory /var/www/${SITE_URL}/assets>
        Header set Cache-Control "public, max-age=31536000, immutable"

        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/css application/javascript
        </IfModule>
    </Directory>

    # Cache control for images - ADD THIS SECTION
    <Directory /var/www/${SITE_URL}/uploads>
        Header set Cache-Control "public, max-age=31536000, immutable"

        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE image/webp
        </IfModule>
    </Directory>

    # No caching for data files - ADD THIS SECTION
    <Directory /var/www/${SITE_URL}/data>
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </Directory>

    # Security headers - ADD THESE
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Logging (you already have this)
    LogLevel debug
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    ServerSignature on

    # Directory index (you already have this)
    <IfModule mod_dir.c>
        DirectoryIndex index.php index.pl index.cgi index.html index.xhtml index.htm
    </IfModule>

    # SSL configuration (you already have this)
    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/${SITE_URL}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/${SITE_URL}/privkey.pem
</VirtualHost>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
