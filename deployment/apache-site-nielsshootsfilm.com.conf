# Apache Configuration for Photography Portfolio Site
#
# This template adds SPA routing, cache control, and reverse proxy for Go backend.
# Based on your working nielsshootsfilm.com.conf
#
# Installation:
# 1. Review the generated configuration
# 2. Copy/merge the additions into /etc/apache2/sites-available/nielsshootsfilm.com.conf
# 3. Enable required modules: sudo a2enmod rewrite headers expires deflate proxy proxy_http
# 4. Test config: sudo apache2ctl configtest
# 5. Reload Apache: sudo systemctl reload apache2
#
# Backend Setup:
# 1. Build backend: cd backend && ./scripts/build.sh
# 2. Deploy binary to /var/www/admin-backend/admin
# 3. Create systemd service (see deployment/README.md)
# 4. Start service: sudo systemctl start photo-admin
# 5. Apache will proxy /api/* requests to http://localhost:8080/api

# HTTP to HTTPS redirect (you already have this configured)
<VirtualHost *:80>
    ServerName nielsshootsfilm.com
    ServerAlias *.nielsshootsfilm.com
    <Location "/">
        Redirect permanent "https://%{HTTP_HOST}%{REQUEST_URI}"
    </Location>
</VirtualHost>

# HTTPS configuration
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName nielsshootsfilm.com
    ServerAlias *.nielsshootsfilm.com

    # Set the main document root
    DocumentRoot /var/www/nielsshootsfilm.com

    # Rewrite www to naked domain (you already have this)
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^www.nielsshootsfilm.com$ [NC]
    RewriteRule ^(.*)$ https://nielsshootsfilm.com$1 [R=301,L]

    # Main directory configuration - ADD SPA ROUTING HERE
    <Directory /var/www/nielsshootsfilm.com/>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted

        # SPA routing - ADD THESE RULES
        RewriteEngine On

        # Prevent rewrite loop - if already rewritten, stop
        RewriteCond %{ENV:REDIRECT_STATUS} !^$
        RewriteRule ^ - [L]

        # Explicitly exclude static file directories from SPA fallback
        RewriteRule ^assets/ - [L]
        RewriteRule ^uploads/ - [L]
        RewriteRule ^data/ - [L]

        # Don't rewrite if the file or directory exists
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d

        # Serve index.html for all other routes (SPA fallback)
        RewriteRule ^ /index.html [L]
    </Directory>

    # Cache control for static assets - ADD THIS SECTION
    <Directory /var/www/nielsshootsfilm.com/assets>
        Header set Cache-Control "public, max-age=31536000, immutable"

        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/css application/javascript
        </IfModule>
    </Directory>

    # Cache control for images - ADD THIS SECTION
    <Directory /var/www/nielsshootsfilm.com/uploads>
        Header set Cache-Control "public, max-age=31536000, immutable"

        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE image/webp
        </IfModule>
    </Directory>

    # No caching for data files - ADD THIS SECTION
    <Directory /var/www/nielsshootsfilm.com/data>
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </Directory>

    # Security headers - ADD THESE
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Reverse proxy for Go admin backend - ADD THIS SECTION
    # All /api/* requests go to the Go backend on port 8080
    ProxyPreserveHost On
    ProxyPass /api http://localhost:8080/api
    ProxyPassReverse /api http://localhost:8080/api

    # Timeout settings for long-running uploads
    ProxyTimeout 300

    # WebSocket support (if needed in the future)
    # RewriteEngine On
    # RewriteCond %{HTTP:Upgrade} websocket [NC]
    # RewriteCond %{HTTP:Connection} upgrade [NC]
    # RewriteRule ^/?(.*) "ws://localhost:8080/$1" [P,L]

    # Logging (you already have this)
    LogLevel debug
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    ServerSignature on

    # Directory index (you already have this)
    <IfModule mod_dir.c>
        DirectoryIndex index.php index.pl index.cgi index.html index.xhtml index.htm
    </IfModule>

    # SSL configuration (you already have this)
    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/nielsshootsfilm.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/nielsshootsfilm.com/privkey.pem
</VirtualHost>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
